<!DOCTYPE html>
<% if (lang == 'en') { %>
<html lang="en">
<% } else { %>
<html lang="en" dir="rtl" class="rtl">
<% } %>

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Meta -->
  <meta name="description" content="HRA Awaran SFD Cyberstate">

  <title>HRA | GIS</title>

  <!-- vendor css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- <link href="theme/lib/font-awesome/css/font-awesome.css" rel="stylesheet"> -->
  <link href="theme/lib/Ionicons/css/ionicons.css" rel="stylesheet">
  <link href="theme/lib/perfect-scrollbar/css/perfect-scrollbar.css" rel="stylesheet">
  <link href="theme/lib/jquery-switchbutton/jquery.switchButton.css" rel="stylesheet">
  <link href="theme/lib/rickshaw/rickshaw.min.css" rel="stylesheet">
  <link href="theme/lib/select2/css/select2.min.css" rel="stylesheet">

  <!-- Bracket CSS -->
  <link rel="stylesheet" href="theme/css/bracket.css">

  <style>
    .l-top {
      margin-top: 1em;
    }

    .top-row {
      margin-left: 0;
      margin-right: 0;
    }

    .virtualPlaceholder {
      display: block;
      height: 171px;
      width: 141px;
      background: #eee;
    }
    .dd {
    padding-left: 1em;
    }
  </style>

</head>

<body class="collapsed-menu">

  <% include ../partials/header %>

  <!-- ########## START: MAIN PANEL ########## -->
  <div class="br-mainpanel">
    <div class="row top-row">
      <div class="col-md-2">
        <div class="br-pagetitle">
          <!-- <i class="icon ion-android-map"></i> -->
          <div>
            <% if (lang == 'en') { %>
            <h3>GIS Dashboard </h3>
            <h6 class="mg-b-0">Last Updated on: <%= LastUpdatedOn %></h6>
            <% } else { %>
            <h3>GIS </h3>
            <% } %>
          </div>
        </div><!-- d-flex -->
      </div>

      <div class="col-md-8">
        <div class="row">
          <div class="col-md-2">
            <div class="l-top rounded overflow-hidden" style="background: #1D2939">
              <p class="tx-14 tx-spacing-1 tx-mont tx-semibold tx-uppercase tx-white-8 mg-b-10 tx-center">
                <% if (lang == 'en') { %>
                APPROVED <br />BENEFICIARIES
                <% } else { %>

                <% } %>
              </p>
              <p class="tx-20 tx-white tx-lato tx-bold mg-b-10 lh-1 tx-center" id="labelTotalCount">
                <%= Beneficiaries.length  %> / 8000</p>
            </div>
          </div><!-- col-8 -->
          <div class="col-md-2">
            <div class="l-top rounded overflow-hidden" style="background: #1D2939">
              <p class="tx-14 tx-spacing-1 tx-mont tx-semibold tx-uppercase tx-white-8 mg-b-10 tx-center">
                <% if (lang == 'en') { %>
                NOT <br />STARTED
                <% } else { %>

                <% } %>
              </p>
              <p class="tx-20  tx-white tx-lato tx-bold mg-b-10 lh-1 tx-center" id="labelNotStarted">
                <%= Beneficiaries.length - CountLevel1InProgress  %>
                / <%= Beneficiaries.length %></p>
            </div>
          </div>
          <div class="col-md-2">
            <div class="l-top rounded overflow-hidden" style="background: #1D2939">
              <p class="tx-14 tx-spacing-1 tx-mont tx-semibold tx-uppercase tx-white-8 mg-b-10 tx-center">
                <% if (lang == 'en') { %>
                Funds Released <br /> by SFD
                <% } else { %>

                <% } %>
              </p>
              <p class="tx-20  tx-white tx-lato tx-bold mg-b-10 lh-1 tx-center" id="labelNotStarted">
                Rs.
                <%= (2079999200).toLocaleString(undefined, {maximumFractionDigits:2}) %></p>
            </div>
          </div>
          <div class="col-md-2">
            <div class="l-top rounded overflow-hidden" style="background: #1D2939">
              <p class="tx-14 tx-spacing-1 tx-mont tx-semibold tx-uppercase tx-white-8 mg-b-10 tx-center">
                <% if (lang == 'en') { %>
                Funds Disbursed <br /> by HRA ( <%= (88).toLocaleString(undefined, {maximumFractionDigits:0}) %>%)
                <% } else { %>

                <% } %>
              </p>
              <p class="tx-20  tx-white tx-lato tx-bold mg-b-10 lh-1 tx-center" id="labelNotStarted">
                Rs.
                <%= (2079999200*0.88).toLocaleString(undefined, {maximumFractionDigits:2}) %></p>
            </div>
          </div>
          <div class="col-md-2">
            <div class="l-top rounded overflow-hidden" style="background: #1D2939">
              <p class="tx-14 tx-spacing-1 tx-mont tx-semibold tx-uppercase tx-white-8 mg-b-10 tx-center">
                <% if (lang == 'en') { %>
                Funds <br /> Un-Utilized (<%= (100-88).toLocaleString(undefined, {maximumFractionDigits:0}) %>%)
                <% } else { %>

                <% } %>
              </p>
              <p class="tx-20  tx-white tx-lato tx-bold mg-b-10 lh-1 tx-center" id="labelNotStarted">
                Rs.
                <%= (2079999200*(1-0.88)).toLocaleString(undefined, {maximumFractionDigits:2}) %></p>
            </div>
          </div>
          <div class="col-md-2">
            <div class="l-top rounded overflow-hidden" style="background: #1D2939">
              <p class="tx-14 tx-spacing-1 tx-mont tx-semibold tx-uppercase tx-white-8 mg-b-10 tx-center">
                <% if (lang == 'en') { %>
                Level 4 <br /> Completed
                <% } else { %>

                <% } %>
              </p>
              <p class="tx-20  tx-white tx-lato tx-bold mg-b-10 lh-1 tx-center" id="labelNotStarted">
                
                <%= CountLevel4Achieved.toLocaleString(undefined, {maximumFractionDigits:0}) %></p>
            </div>
          </div>
         
        </div>
      </div>
      <div class="col-md-2">
        <div class="row">
          <div class="col-md-12">
            <div class="row no-gutters l-top" style="background: #1D2939">
              <div class="form-group mg-md-l--1 bd-t-0-force dd">
                <label class="form-control-label mg-b-10-force tx-14 tx-spacing-1 tx-mont tx-semibold tx-uppercase tx-white-8 mg-b-10">Union Council (UC):<span class="tx-danger">*</span></label>
                <select id="select2-UC" class="form-control" data-placeholder="Select a UC" style="width:100%">
                  <option value="0">All UC</option>
                  <% UCs.forEach(function(uc) { %>
                  <option value="<%= uc.UCID %> "><%= uc.UCName %></option>
                  <% }) %>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="br-pagebody">
      <div class="br-section-wrapper">

        <div class="row row-sm">
          <div class="col-lg-12">
            <div id="map" style="width:100%;height:78vh"></div>
          </div>
        </div><!-- row -->
        <div class="row row-sm">
          <div id="legend" class="col-lg-12">

          </div>
        </div><!-- row -->
      </div>
    </div><!-- br-pagebody -->
    <% include ../partials/footer %>
  </div><!-- br-mainpanel -->
  <!-- ########## END: MAIN PANEL ########## -->

  <script src="theme/lib/jquery/jquery.js"></script>
  <script src="theme/js/popper.js"></script>
  <script src="theme/lib/bootstrap/js/bootstrap.js"></script>
  <script src="theme/lib/perfect-scrollbar/js/perfect-scrollbar.jquery.js"></script>
  <script src="theme/lib/moment/moment.js"></script>
  <script src="theme/lib/jquery-ui/jquery-ui.js"></script>
  <script src="theme/lib/jquery-switchbutton/jquery.switchButton.js"></script>
  <script src="theme/lib/peity/jquery.peity.js"></script>
  <script src="theme/lib/d3/d3.js"></script>
  <script src="theme/lib/rickshaw/rickshaw.min.js"></script>
  <script src="theme/lib/Flot/jquery.flot.js"></script>
  <script src="theme/lib/Flot/jquery.flot.resize.js"></script>
  <script src="theme/lib/flot-spline/jquery.flot.spline.js"></script>
  <script src="theme/lib/jquery.sparkline.bower/jquery.sparkline.min.js"></script>
  <script src="theme/lib/select2/js/select2.min.js"></script>
  <script src="http://maps.google.com/maps/api/js?key=AIzaSyAtFS563VrFYCkOBmG8J2-noujJ9gP18EM&libraries=marker"></script>


  <script src="theme/lib/gmaps/gmaps.js"></script>


  <script src="theme/js/bracket.js"></script>


  <script async>
    $(function() {
      $(document).ready(function() {
        'use strict'
        $('#select2-a, #select2-UC, #select2-Village').select2({
          minimumResultsForSearch: Infinity
        });
        var selectedID = "";
        var zoomLevel = 9;
        var markers = [];
        var markers_ucs = [];
        const ucColorPalette = ["#33a8c7", "#52e3e1", "#a0e426", "#fdf148", "#ffab00", "#f77976", "#f050ae", "#d883ff", "#9336fd"];
        const ucColorPalette2 = ["f77976", "f050ae", "d883ff", "9336fd", "33a8c7", "52e3e1", "a0e426", "fdf148", "ffab00"];
        const legend = document.getElementById("legend");
        let legendHTML = "<br/>";
        let ucs = JSON.parse(htmlDecode("<%= JSON.stringify(UCs) %>")).reduce((p, c) => {
          p[c.UCID] = c.UCName;
          return p
        }, {});
        Object.keys(ucs).map((c, i) => {
          legendHTML += `<i class="fa fa-circle fa-lg" style="color: ${ucColorPalette[c]}"></i> ${ucs[c]}&nbsp &nbsp`
        })
        legend.innerHTML = legendHTML;
        const getPin = function({
          MonitoringLevel: monitoringLevel,
          LevelStatus: levelStatus,
          InstallmentType: installment = null,
          UCID: ucId = 0
        }) {
          let pin = null;

          if (monitoringLevel > 0 && levelStatus == 2 && installment > monitoringLevel) {
            // A marker using a Font Awesome icon for the glyph.
            const icon = document.createElement('div');
            icon.innerHTML = `<i class="fa fa-${monitoringLevel} fa-lg"><sup>!</sup></i>`;
            pin = new google.maps.marker.PinElement({
              glyph: icon,
              glyphColor: 'black',
              background: ucColorPalette[ucId],
              borderColor: '#28231d',
            }).element
            //check if level-1 is achieved
          } else if (monitoringLevel > 0 && levelStatus == 2) {
            // A marker using a Font Awesome icon for the glyph.
            const icon = document.createElement('div');
            icon.innerHTML = `<i class="fa fa-${monitoringLevel} fa-lg"></i>`;
            pin = new google.maps.marker.PinElement({
              glyph: icon,
              glyphColor: 'black',
              background: ucColorPalette[ucId],
              borderColor: '#28231d',
            }).element
            //check if level-1 is achieved
          } else {
            const icon = document.createElement('div');
            icon.innerHTML = `<i class="fa fa-0 fa-lg"></i>`;
            pin = new google.maps.marker.PinElement({
              glyph: icon,
              glyphColor: 'black',
              background: ucColorPalette[ucId],
              borderColor: '#28231d',
            }).element
          }

          return pin;


        }

        function load_content(marker, beneficiary) {
          infowindow.setContent();
          //infowindow.setHeaderContent('Loading...');


          let temp = '<strong style="color:red;">NONE</strong><br>';
          var progress1 = 'PROGRESS: <strong style="color:red;">' + '0' + '%</strong>';

          if (beneficiary.InstallmentType == 1) {
            temp = '<strong style="color:blue;">1st</strong>';

          }
          if (beneficiary.InstallmentType == 2) {
            temp = '<strong style="color:blue;">2nd</strong>';
          }
          if (beneficiary.InstallmentType == 3) {
            temp = '<strong style="color:blue;">3rd</strong>';
          }
          if (beneficiary.InstallmentType == 4) {
            temp = '<strong style="color:blue;">4th</strong>';
          }

          if (beneficiary.MonitoringLevel == 1 && beneficiary.LevelStatus == 2) {
            progress1 = '<strong style="color:#edc951 ;">' + 'LEVEL-1 ACHIEVED' + '</strong>';
          } else if (beneficiary.MonitoringLevel == 1 && beneficiary.LevelStatus == 1) {
            progress1 = '<strong style="color:#edc951 ;">' + 'LEVEL-1 IN-PROGRESS' + '</strong>';
          } else if (beneficiary.MonitoringLevel == 2 && beneficiary.LevelStatus == 1) {
            progress1 = '<strong style="color:#edc951 ;">' + 'LEVEL-2 IN-PROGRESS' + '</strong>';
          } else if (beneficiary.MonitoringLevel == 2 && beneficiary.LevelStatus == 2) {
            progress1 = '<strong style="color:#edc951 ;">' + 'LEVEL-2 ACHIEVED' + '</strong>';
          } else if (beneficiary.MonitoringLevel == 3 && beneficiary.LevelStatus == 1) {
            progress1 = '<strong style="color:#edc951 ;">' + 'LEVEL-3 IN-PROGRESS' + '</strong>';
          } else if (beneficiary.MonitoringLevel == 3 && beneficiary.LevelStatus == 2) {
            progress1 = '<strong style="color:#edc951 ;">' + 'LEVEL-3 ACHIEVED' + '</strong>';
          } else if (beneficiary.MonitoringLevel == 4 && beneficiary.LevelStatus == 1) {
            progress1 = '<strong style="color:#edc951 ;">' + 'LEVEL-4 IN-PROGRESS' + '</strong>';
          } else if (beneficiary.MonitoringLevel == 4 && beneficiary.LevelStatus == 2) {
            progress1 = '<strong style="color:#edc951 ;">' + 'LEVEL-4 ACHIEVED' + '</strong>';
          }


          const imgId = "i" + Date.now() + Math.floor(Math.random() * 100)
          infowindow.setContent('<div id="iw-container">' +

            '<div class="iw-content" style="max-height: none">' +

            '<img class="virtualPlaceholder" id="' + imgId + '" src="">' +

            '<p>UC :' + ucs[beneficiary.UCID] + '<br/>STATUS: <strong style="color:green;">APPROVED</strong><br>' +
            'INSTALLMENT PAID: ' + temp + '<br>' + progress1 +
            '<br>PHONE: ' + beneficiary.PhonePrimary +
            '<a href="/beneficiary/detail?CNIC=' + beneficiary.CNIC + '"><br>MONITORING DETAIL</a>' + '</p>' +
            '</div>' +
            '</div>');
          const header = document.createElement("h3");
          header.textContent = beneficiary.FirstName + ' ' + beneficiary.LastName;
          infowindow.setHeaderContent(header);
          infowindow.open(map, marker);




          $.ajax({
            url: '/beneficiary/getBeneficiaryPhotoByCNIC?CNIC=' + beneficiary.CNIC,
            success: function(data) {
              document.getElementById(imgId).src = data
            }
          });

        }



        $('#select2-UC').on('select2:select', function(e) {
          var data = e.params.data;
          selectedID = Number(data.id);



          markers.forEach(marker => {
            if (selectedID != 0 && marker["ucid"] != selectedID)
              marker.map = null;
            else
              marker.map = map;
          })




        });
        var map;

        document.getElementById("li-beneficiary").classList.add('active');
        document.getElementById("gis-dashboard").classList.add('active');

        function htmlDecode(input) {
          var e = document.createElement('div');
          e.innerHTML = input;
          return e.childNodes.length === 0 ? "" : e.childNodes[0].nodeValue;
        }
        var lang = JSON.parse(htmlDecode("<%= JSON.stringify(lang) %>"));

        var Beneficiaries = JSON.parse('<%- JSON.stringify(Beneficiaries) %>');
        var CountLevel1InProgress = JSON.parse('<%- JSON.stringify(CountLevel1InProgress) %>');
        var CountLevel1Achieved = JSON.parse('<%- JSON.stringify(CountLevel1Achieved) %>');
        var CountLevel2InProgress = JSON.parse('<%- JSON.stringify(CountLevel2InProgress) %>');
        var CountLevel2Achieved = JSON.parse('<%- JSON.stringify(CountLevel2Achieved) %>');
        var CountLevel3InProgress = JSON.parse('<%- JSON.stringify(CountLevel3InProgress) %>');
        var CountLevel3Achieved = JSON.parse('<%- JSON.stringify(CountLevel3Achieved) %>');
        var CountLevel4InProgress = JSON.parse('<%- JSON.stringify(CountLevel4InProgress) %>');
        var CountLevel4Achieved = JSON.parse('<%- JSON.stringify(CountLevel4Achieved) %>');

        var myLatLng = new google.maps.LatLng(Beneficiaries[0].VHLatitude, Beneficiaries[0].VHLongitude);

        var myOptions = {
          mapId: "gis",
          zoom: 12,
          center: myLatLng,
          scrollwheel: false,
          zoomControl: true,
          navigationControl: false,
          mapTypeControl: false,
          _mapTypeId: 'hybrid',

          scaleControl: false,
          draggable: true,
          s_tyles: [{
            featureType: 'all',
            stylers: [{
              saturation: -80
            }]
          }, {
            featureType: 'road.arterial',
            elementType: 'geometry',
            stylers: [{
                hue: '#00ffee'
              },
              {
                saturation: 50
              }
            ]
          }, {
            featureType: 'poi.business',
            elementType: 'labels',
            stylers: [{
              visibility: 'off'
            }]
          }]
          //mapTypeId: google.maps.MapTypeId.TERRAIN
        };
        map = new google.maps.Map(document.getElementById('map'), myOptions);
        var bounds = new google.maps.LatLngBounds();


        // Display multiple markers on a map
        // Loop through our array of markers & place each one on the map
        for (let i = 0; i < Beneficiaries.length; i++) {

          if (Beneficiaries[i].VHLatitude == 0 || !Beneficiaries[i].VHLatitude) {
            continue;
          }
          var infowindow = new google.maps.InfoWindow({
            content: Beneficiaries[i].FirstName
          });
          var position = new google.maps.LatLng(Beneficiaries[i].VHLatitude, Beneficiaries[i].VHLongitude);
          bounds.extend(position);



          var marker = new google.maps.marker.AdvancedMarkerElement({
            position: position,
            map: map,
            title: Beneficiaries[i].FirstName + " - " + ucs[Beneficiaries[i].UCID],
            content: getPin(Beneficiaries[i])
          });
          marker["ucid"] = Beneficiaries[i].UCID;
          markers.push(marker);
          // Automatically center the map fitting all markers on the screen
          map.fitBounds(bounds);
          map.setCenter(marker.position);

          google.maps.event.addListener(marker, 'click', (function(marker, i) {
            return function() {
              load_content(marker, Beneficiaries[i]);
              infowindow.open(map, marker);
            }
          })(marker, i));
        }

        // Override our map zoom level once our fitBounds function runs (Make sure it only runs once)
        var boundsListener = google.maps.event.addListener((map), 'bounds_changed', function(event) {
          //this.setZoom(zoomLevel);
          google.maps.event.removeListener(boundsListener);
        });
        // Sets the map on all markers in the array.
        function setMapOnAll(map) {
          for (var i = 0; i < markers.length; i++) {
            markers[i].setMap(map);
          }
        }

        // Removes the markers from the map, but keeps them in the array.
        function clearMarkers() {
          setMapOnAll(null);
        }

        // Removes the markers from the map, but keeps them in the array.
        function redrawMarkers() {
          setMapOnAll(map);
        }

        // FOR DEMO ONLY
        // menu collapsed by default during first page load or refresh with screen
        // having a size between 992px and 1299px. This is intended on this page only
        // for better viewing of widgets demo.
        $(window).resize(function() {
          minimizeMenu();
        });

        minimizeMenu();




        function minimizeMenu() {
          if (window.matchMedia('(min-width: 992px)').matches && window.matchMedia('(max-width: 1299px)').matches) {
            // show only the icons and hide left menu label by default
            $('.menu-item-label,.menu-item-arrow').addClass('op-lg-0-force d-lg-none');
            $('body').addClass('collapsed-menu');
            $('.show-sub + .br-menu-sub').slideUp();
          } else if (window.matchMedia('(min-width: 1300px)').matches && !$('body').hasClass('collapsed-menu')) {
            $('.menu-item-label,.menu-item-arrow').removeClass('op-lg-0-force d-lg-none');
            $('body').removeClass('collapsed-menu');
            $('.show-sub + .br-menu-sub').slideDown();
          }
        }

      });
    });
  </script>
</body>

</html>